rules_version = '2';

/**
 * 모꼬지 Firestore Security Rules
 *
 * 주요 보안 원칙:
 * 1. 인증된 사용자만 데이터 접근 가능
 * 2. 사용자는 자신의 데이터만 수정 가능
 * 3. 크루 멤버만 크루 일정 및 채팅 접근 가능
 * 4. 소프트 삭제 패턴 (isDeleted 플래그)
 */

service cloud.firestore {
  match /databases/{database}/documents {

    // ============================================
    // Helper Functions
    // ============================================

    /**
     * 사용자가 인증되었는지 확인
     */
    function isAuthenticated() {
      return request.auth != null;
    }

    /**
     * 현재 사용자 ID
     */
    function currentUserId() {
      return request.auth.uid;
    }

    /**
     * 사용자가 특정 크루의 멤버인지 확인
     */
    function isOrganizationMember(orgId) {
      return isAuthenticated() &&
             exists(/databases/$(database)/documents/organization_members/$(orgId + '_' + currentUserId()));
    }

    /**
     * 사용자가 특정 일정의 참가자인지 확인
     * Note: Firestore Rules에서는 map() 사용 불가, 직접 체크
     */
    function isScheduleParticipant(scheduleData) {
      return isAuthenticated();
      // Note: participants 배열 내 userId 체크는 rules에서 제한적
      // 대신 isOrganizationMember로 크루 멤버 체크
    }

    /**
     * 데이터가 삭제되지 않았는지 확인
     */
    function isNotDeleted(data) {
      return !('isDeleted' in data) || data.isDeleted == false;
    }

    // ============================================
    // User Profiles (profiles)
    // ============================================

    match /profiles/{userId} {
      // 읽기: 인증된 사용자 누구나
      allow read: if isAuthenticated() && isNotDeleted(resource.data);

      // 생성: 자기 자신의 프로필만
      allow create: if isAuthenticated() &&
                       currentUserId() == userId &&
                       request.resource.data.userId == userId;

      // 수정: 자기 자신의 프로필만
      allow update: if isAuthenticated() &&
                       currentUserId() == userId &&
                       request.resource.data.userId == userId;

      // 삭제: 자기 자신의 프로필만 (소프트 삭제 권장)
      allow delete: if isAuthenticated() && currentUserId() == userId;
    }

    // ============================================
    // Organizations (organizations)
    // ============================================

    match /organizations/{orgId} {
      // 읽기: 크루 멤버만
      allow read: if isAuthenticated() &&
                     isOrganizationMember(orgId) &&
                     isNotDeleted(resource.data);

      // 생성: 인증된 사용자 (새 크루 생성)
      allow create: if isAuthenticated() &&
                       currentUserId() in request.resource.data.memberIds;

      // 수정: 크루 멤버만
      allow update: if isAuthenticated() &&
                       isOrganizationMember(orgId);

      // 삭제: 크루 소유자만 (향후 구현)
      allow delete: if false; // 소프트 삭제 권장
    }

    // ============================================
    // Organization Members (organization_members)
    // ============================================

    match /organization_members/{memberId} {
      // 읽기: 해당 크루의 멤버만
      allow read: if isAuthenticated() &&
                     isOrganizationMember(resource.data.organizationId) &&
                     isNotDeleted(resource.data);

      // 생성: 크루 관리자 또는 초대 시스템
      allow create: if isAuthenticated();

      // 수정: 본인의 멤버십 정보만
      allow update: if isAuthenticated() &&
                       (currentUserId() == resource.data.userId ||
                        isOrganizationMember(resource.data.organizationId));

      // 삭제: 본인의 멤버십만
      allow delete: if isAuthenticated() &&
                       currentUserId() == resource.data.userId;
    }

    // ============================================
    // Schedules (org_schedules)
    // ============================================

    match /org_schedules/{scheduleId} {
      // 읽기: 크루 멤버만
      allow read: if isAuthenticated() &&
                     isOrganizationMember(resource.data.organizationId) &&
                     isNotDeleted(resource.data);

      // 생성: 크루 멤버만
      allow create: if isAuthenticated() &&
                       isOrganizationMember(request.resource.data.organizationId);

      // 수정: 크루 멤버만 (참석 응답, 일정 수정 등)
      allow update: if isAuthenticated() &&
                       isOrganizationMember(resource.data.organizationId);

      // 삭제: 일정 생성자만
      allow delete: if isAuthenticated() &&
                       currentUserId() == resource.data.createdBy;
    }

    // ============================================
    // Chat Messages (schedule_chats)
    // ============================================

    match /schedule_chats/{messageId} {
      /**
       * 메시지 접근 권한 확인
       * - 해당 일정의 참가자만 채팅 읽기/쓰기 가능
       */
      function canAccessChat() {
        let scheduleId = request.resource.data.scheduleId;
        let scheduleDoc = get(/databases/$(database)/documents/org_schedules/$(scheduleId));

        return isAuthenticated() &&
               isOrganizationMember(scheduleDoc.data.organizationId) &&
               scheduleDoc.data.hasChat == true &&
               isNotDeleted(scheduleDoc.data);
      }

      // 읽기: 일정 참가자만
      allow read: if isAuthenticated() &&
                     isNotDeleted(resource.data) &&
                     exists(/databases/$(database)/documents/org_schedules/$(resource.data.scheduleId));

      // 생성: 일정 참가자만 (시스템 메시지는 Cloud Function에서)
      allow create: if canAccessChat() &&
                       (request.resource.data.senderId == currentUserId() ||
                        request.resource.data.type == 'system');

      // 수정: 본인의 메시지만 (5분 이내)
      allow update: if isAuthenticated() &&
                       resource.data.senderId == currentUserId() &&
                       request.time < resource.data.createdAt + duration.value(5, 'm');

      // 삭제: 본인의 메시지만 (소프트 삭제 권장)
      allow delete: if isAuthenticated() &&
                       resource.data.senderId == currentUserId();
    }

    // ============================================
    // Activity Logs (activity_logs)
    // ============================================

    match /activity_logs/{logId} {
      // 읽기: 크루 멤버만
      allow read: if isAuthenticated() &&
                     isOrganizationMember(resource.data.organizationId);

      // 생성: Cloud Function 또는 시스템만
      allow create: if false;

      // 수정/삭제: 불가
      allow update, delete: if false;
    }

    // ============================================
    // Default Deny
    // ============================================

    // 명시되지 않은 모든 컬렉션은 접근 불가
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
