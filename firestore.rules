rules_version = '2';

/**
 * ëª¨ê¼¬ì§€ Firestore Security Rules
 *
 * ğŸ›¡ï¸ ì¤‘ìš” ë°ì´í„° ë³´í˜¸:
 * - organizationMembers.joinedAt: ìƒì„± ì‹œì—ë§Œ ì„¤ì • ê°€ëŠ¥, ì´í›„ ìˆ˜ì • ë¶ˆê°€
 * - ë‹¤ë¥¸ í•„ë“œëŠ” ì •ìƒì ìœ¼ë¡œ ì½ê¸°/ì“°ê¸° ê°€ëŠ¥
 */

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper Functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function currentUserId() {
      return request.auth.uid;
    }

    // ============================================
    // organizationMembers: joinedAt í•„ë“œ ë³´í˜¸
    // ============================================
    match /organizationMembers/{memberId} {
      // ì½ê¸°ëŠ” ì¸ì¦ëœ ì‚¬ìš©ì ëª¨ë‘ í—ˆìš©
      allow read: if isAuthenticated();

      // ìƒì„±: joinedAt í•„ë“œ í•„ìˆ˜, í•œ ë²ˆë§Œ ì„¤ì • ê°€ëŠ¥
      allow create: if isAuthenticated()
                    && request.resource.data.keys().hasAll(['joinedAt', 'userId', 'organizationId']);

      // ìˆ˜ì •: joinedAt í•„ë“œëŠ” ì ˆëŒ€ ë³€ê²½ ë¶ˆê°€ (ê¸°ì¡´ ê°’ ìœ ì§€ í•„ìˆ˜)
      allow update: if isAuthenticated()
                    && (!request.resource.data.keys().hasAny(['joinedAt'])
                        || request.resource.data.joinedAt == resource.data.joinedAt);

      // ì‚­ì œëŠ” í—ˆìš©
      allow delete: if isAuthenticated();
    }

    // ============================================
    // userProfiles: ì¼ë°˜ì ì¸ ì½ê¸°/ì“°ê¸°
    // ============================================
    match /userProfiles/{userId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // ============================================
    // organizations: ì¼ë°˜ì ì¸ ì½ê¸°/ì“°ê¸°
    // ============================================
    match /organizations/{orgId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // ============================================
    // org_schedules: ì¼ë°˜ì ì¸ ì½ê¸°/ì“°ê¸°
    // ============================================
    match /org_schedules/{scheduleId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();

      // í•˜ìœ„ ì»¬ë ‰ì…˜ (messages ë“±)
      match /{document=**} {
        allow read, write: if isAuthenticated();
      }
    }

    // ============================================
    // org_activity_logs: ì¼ë°˜ì ì¸ ì½ê¸°/ì“°ê¸°
    // ============================================
    match /org_activity_logs/{logId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // ============================================
    // org_schedules_archive: ì¼ë°˜ì ì¸ ì½ê¸°/ì“°ê¸°
    // ============================================
    match /org_schedules_archive/{scheduleId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // ============================================
    // ê¸°íƒ€ ì»¬ë ‰ì…˜: ê¸°ë³¸ ê¶Œí•œ
    // ============================================
    match /{document=**} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
  }
}
